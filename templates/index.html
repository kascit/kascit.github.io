{% import "macros/head.html" as macros_head %}
{% import "macros/search.html" as macros_search %}
{% import "macros/header.html" as macros_header %}
{% import "macros/comments.html" as macros_comments %}
{% import "macros/toc.html" as macros_toc %}
{% import "macros/footer.html" as macros_footer %}
{% import "macros/sidebar.html" as macros_sidebar %}

<!DOCTYPE html>
{{ macros_head::html_tag(config=config, lang=lang) }}
<head>
    {% if page is defined %}
        {{ macros_head::head(config=config, page=page, section=false, current_url=config.base_url) }}
    {% elif section is defined %}
        {{ macros_head::head(config=config, page=false, section=section, current_url=config.base_url) }}
    {% else %}
        {{ macros_head::head(config=config, page=false, section=false, current_url=config.base_url) }}
    {% endif %}
    {% block extra_head %}{% endblock extra_head %}
</head>
<body>
    {{ macros_search::search(config=config) }}

    <div class="drawer lg:drawer-open">
        <input id="my-drawer-2" type="checkbox" class="drawer-toggle" autocomplete="off" />
        <div class="drawer-content flex flex-col pt-16">
            {{ macros_header::header(config=config, lang=lang) }}

            {% set lang_root_path = "/" ~ lang ~ "/" %}
            {# Sidebar configuration with backward compatibility #}
            {# Priority: sidebar.disable_root_hide (new) > disable_root_sidebar_hide (legacy) #}
            {% if config.extra.sidebar is defined %}
                {% set disable_root_sidebar_hide = config.extra.sidebar.disable_root_hide | default(value=config.extra.disable_root_sidebar_hide | default(value=false)) %}
            {% else %}
                {% set disable_root_sidebar_hide = config.extra.disable_root_sidebar_hide | default(value=false) %}
            {% endif %}
            {% if section is defined and (section.path == "/" or section.path == lang_root_path) and not disable_root_sidebar_hide %}
            <div class="w-full">
                <main class="prose w-full mx-auto">
                    {% block content %}{% endblock content %}

                    {{ macros_comments::comments(config=config, page=page|default(value=false), section=section|default(value=false)) }}

                    <nav class="mt-12 pt-8 border-t border-gray-500/15">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="prev-nav-item">
                                {% block prev_link %}{% endblock prev_link %}
                            </div>
                            <div class="next-nav-item">
                                {% block next_link %}{% endblock next_link %}
                            </div>
                        </div>
                    </nav>
                </main>
            </div>
            {% else %}
            <div class="p-8 w-full flex justify-center">
                <div class="w-full max-w-7xl lg:grid lg:grid-cols-[1fr_250px] lg:gap-8">
                    <main class="prose w-full">
                        {% block content %}{% endblock content %}

                        {{ macros_comments::comments(config=config, page=page|default(value=false), section=section|default(value=false)) }}

                        <nav class="mt-12 pt-8 border-t border-gray-500/15">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="prev-nav-item">
                                    {% block prev_link %}{% endblock prev_link %}
                                </div>
                                <div class="next-nav-item">
                                    {% block next_link %}{% endblock next_link %}
                                </div>
                            </div>
                        </nav>
                    </main>

                    {% block toc_sidebar %}
                    {% if page is defined %}
                        {{ macros_toc::toc(page=page) }}
                    {% endif %}
                    {% if section is defined %}
                        {{ macros_toc::toc(page=section) }}
                    {% endif %}
                    {% endblock toc_sidebar %}
                </div>
            </div>
            {% endif %}

                        {% if config.extra.theme is defined %}
                                {% set js_theme_colorset = config.extra.theme.colorset | default(value=config.extra.default_colorset | default(value='dark')) %}
                                {% set js_common_brightness = config.extra.theme.brightness | default(value=config.extra.brightness | default(value='normal')) %}
                                {% set js_dark_brightness = config.extra.theme.dark_brightness | default(value=js_common_brightness) %}
                                {% set js_light_brightness = config.extra.theme.light_brightness | default(value=js_common_brightness) %}
                        {% else %}
                                {% set js_theme_colorset = config.extra.default_colorset | default(value='dark') %}
                                {% set js_common_brightness = config.extra.brightness | default(value='normal') %}
                                {% set js_dark_brightness = js_common_brightness %}
                                {% set js_light_brightness = js_common_brightness %}
                        {% endif %}
                        <script defer src="{{ get_url(path='js/page-init.js') | safe }}"
                                        data-default-colorset="{{ js_theme_colorset }}"
                                        data-dark-brightness="{{ js_dark_brightness }}"
                                        data-light-brightness="{{ js_light_brightness }}"></script>

        </div>

        {% set lang_root_path = "/" ~ lang ~ "/" %}
        {# Sidebar configuration with backward compatibility (reuse the value from above) #}
        {% if section is defined and (section.path == "/" or section.path == lang_root_path) and not disable_root_sidebar_hide %}
        {# On landing page: hide sidebar on desktop, keep drawer available on mobile #}
        <div id="sidebar" class="drawer-side pt-16 border-e border-gray-500/15 overflow-hidden lg:hidden">
        {% else %}
        <div id="sidebar" class="drawer-side pt-16 border-e border-gray-500/15 overflow-hidden">
        {% endif %}
            {% if section is defined %}
                {{ macros_sidebar::sidebar(config=config, lang=lang, current_path=current_path, section=section) }}
            {% else %}
                {{ macros_sidebar::sidebar(config=config, lang=lang, current_path=current_path, section=false) }}
            {% endif %}
        </div>
    </div>

    {% block js_body %}
        <script defer src="{{ get_url(path='goyo.js') | safe }}"></script>
        {% if config.build_search_index %}
        <script defer src="{{ get_url(path='js/search-loader.js') | safe }}"
                data-lang="{{ lang | default(value='en') }}"
                data-fuse="{{ get_url(path="fuse.min.js") | safe }}"
                data-search-index="{{ get_url(path="search_index." ~ lang ~ ".js") | safe }}"></script>
        {% endif %}
    {% endblock js_body %}
</body>
</html>
