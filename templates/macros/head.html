{% macro get_theme_color(config) %}
{# Theme configuration with backward compatibility #}
{# Priority: theme.dark_brightness/light_brightness (new per-theme) > theme.brightness (common) > brightness (legacy) #}
{% if config.extra.theme is defined %}
    {%- set colorset = config.extra.theme.colorset | default(value=config.extra.default_colorset | default(value='dark')) -%}
    {%- set common_brightness = config.extra.theme.brightness | default(value=config.extra.brightness | default(value='normal')) -%}
    {%- set dark_brightness = config.extra.theme.dark_brightness | default(value=common_brightness) -%}
    {%- set light_brightness = config.extra.theme.light_brightness | default(value=common_brightness) -%}
{% else %}
    {%- set colorset = config.extra.default_colorset | default(value='dark') -%}
    {%- set dark_brightness = config.extra.brightness | default(value='normal') -%}
    {%- set light_brightness = config.extra.brightness | default(value='normal') -%}
{% endif %}
{%- if colorset == "dark" and dark_brightness == "darker" -%}
#000000
{%- elif colorset == "dark" and dark_brightness == "lighter" -%}
#1e293b
{%- elif colorset == "dark" -%}
#0f172a
{%- elif colorset == "light" and light_brightness == "darker" -%}
#e2e8f0
{%- elif colorset == "light" and light_brightness == "lighter" -%}
#ffffff
{%- elif colorset == "light" -%}
#ffffff
{%- else -%}
#0f172a
{%- endif -%}
{% endmacro get_theme_color %}

{% macro html_tag(config, lang) %}
{%- set theme_color = self::get_theme_color(config=config) | trim -%}
{%- set is_rtl = false -%}
{%- if config.extra.lang is defined and config.extra.lang.rtl is defined -%}
    {%- if lang in config.extra.lang.rtl -%}
        {%- set is_rtl = true -%}
    {%- endif -%}
{%- endif -%}
<html lang="{{ lang | default(value='en') }}"{% if is_rtl %} dir="rtl"{% endif %} style="background-color: {{ theme_color }};">
{% endmacro html_tag %}

{% macro head(config, page, section, current_url) %}
    {# current_url이 정의되어 있지 않으면 기본값으로 설정 #}
    {% if current_url is not defined or current_url == "" %}
        {% set current_url = config.base_url %}
    {% endif %}
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Security headers are now managed in _headers file for better control -->
    <!-- CSP, HSTS, COOP, X-Frame-Options, etc. are configured via HTTP headers -->
    <meta name="referrer" content="strict-origin-when-cross-origin">

    <!-- Resource Hints for better performance -->
    {% if config.extra.gtag and config.extra.gtag != "" %}
    <link rel="preconnect" href="https://www.googletagmanager.com" crossorigin>
    <link rel="preconnect" href="https://www.google-analytics.com" crossorigin>
    <link rel="dns-prefetch" href="https://www.googletagmanager.com">
    <link rel="dns-prefetch" href="https://www.google-analytics.com">
    {% endif %}
    {# Preload critical fonts to reduce critical path latency #}
    <link rel="preload" href="{{ get_url(path="webfonts/fa-solid-900.woff2") | safe }}" as="font" type="font/woff2" crossorigin>
    <link rel="preload" href="{{ get_url(path="webfonts/fa-brands-400.woff2") | safe }}" as="font" type="font/woff2" crossorigin>
    <link rel="preload" href="{{ get_url(path="fonts/Pretendard-Regular.woff") | safe }}" as="font" type="font/woff" crossorigin>

    {% if config.extra.theme is defined %}
        {% set theme_colorset = config.extra.theme.colorset | default(value=config.extra.default_colorset | default(value='dark')) %}
        {% set common_brightness = config.extra.theme.brightness | default(value=config.extra.brightness | default(value='normal')) %}
        {% set dark_brightness = config.extra.theme.dark_brightness | default(value=common_brightness) %}
        {% set light_brightness = config.extra.theme.light_brightness | default(value=common_brightness) %}
    {% else %}
        {% set theme_colorset = config.extra.default_colorset | default(value='dark') %}
        {% set common_brightness = config.extra.brightness | default(value='normal') %}
        {% set dark_brightness = common_brightness %}
        {% set light_brightness = common_brightness %}
    {% endif %}
    <!-- Inline critical theme init to prevent FOUC, but kept minimal -->
    <script>
        (function() {
            var colorset = localStorage.getItem('colorset') || '{{ theme_colorset }}';
            var darkBrightness = localStorage.getItem('darkBrightness') || '{{ dark_brightness }}';
            var lightBrightness = localStorage.getItem('lightBrightness') || '{{ light_brightness }}';
            if (colorset === 'dark') {
                document.documentElement.classList.add('dark');
                document.documentElement.style.colorScheme = 'dark';
            } else {
                document.documentElement.classList.add('light');
                document.documentElement.style.colorScheme = 'light';
            }
        })();
    </script>
    <!-- Defer full theme initialization for performance -->
    <script src="{{ get_url(path="js/theme-init.js") | safe }}" defer
            data-default-colorset="{{ theme_colorset }}"
            data-dark-brightness="{{ dark_brightness }}"
            data-light-brightness="{{ light_brightness }}"></script>

    <style>
        {# Font configuration with backward compatibility #}
        {# Priority: font.* (new) > custom_font_* (legacy) #}
        {% if config.extra.font is defined %}
            {% set font_enabled = config.extra.font.enabled | default(value=config.extra.custom_font_enabled | default(value=false)) %}
            {% set font_name = config.extra.font.name | default(value=config.extra.custom_font_name | default(value='CustomFont')) %}
            {% set font_path = config.extra.font.path | default(value=config.extra.custom_font_path | default(value='')) %}
        {% else %}
            {% set font_enabled = config.extra.custom_font_enabled | default(value=false) %}
            {% set font_name = config.extra.custom_font_name | default(value='CustomFont') %}
            {% set font_path = config.extra.custom_font_path | default(value='') %}
        {% endif %}
        {% if font_enabled and font_path != '' %}
            {# Custom font configuration #}
            {% if font_path is starting_with("http://") or font_path is starting_with("https://") %}
                {# Remote font URL - use @import #}
                @import url('{{ font_path | safe }}');
            {% else %}
                {# Local font file - use @font-face #}
                @font-face {
                    font-family: "{{ font_name }}";
                    src: url('{{ get_url(path=font_path) | safe }}') format("woff");
                    font-weight: 400;
                    font-style: normal;
                    font-display: swap;
                }
            {% endif %}
            body {
                font-family: "{{ font_name }}", sans-serif;
            }
        {% else %}
            {# Default Pretendard font with font-display swap for better performance #}
            @font-face {
                font-family: "Pretendard-Regular";
                src: url('{{ get_url(path="fonts/Pretendard-Regular.woff") | safe }}') format("woff");
                font-weight: 400;
                font-style: normal;
                font-display: swap;
            }
            body {
                font-family: "Pretendard-Regular", sans-serif;
            }
        {% endif %}
    </style>

    {% if page %}
        {% if page.description %}
            <meta name="description" content="{{ page.description }}" />
        {% elif config.description %}
            <meta name="description" content="{{ config.description }}" />
        {% endif %}
    {% elif config.description %}
        <meta name="description" content="{{ config.description }}" />
    {% endif %}

    <title>
      {%- if page and page.title -%}
        {{ page.title }} | {{ config.title | default(value="Goyo") }}
      {%- elif section and section.title -%}
        {{ section.title }} | {{ config.title | default(value="Goyo") }}
      {%- elif config.title -%}
        {{ config.title }}
      {%- else -%}
        Goyo
      {%- endif -%}
    </title>

    {# Google Analytics gtag.js integration - deferred to not block rendering #}
        {% if config.extra.gtag and config.extra.gtag != "" %}
        <!-- Google tag (gtag.js) -->
        <script async src="https://www.googletagmanager.com/gtag/js?id={{ config.extra.gtag }}"></script>
        <script src="{{ get_url(path="js/gtag-init.js") | safe }}" defer data-gtag-id="{{ config.extra.gtag }}"></script>
        {% endif %}

      <!-- SEO: Open Graph / Twitter Card -->
      <meta property="og:title" content="
        {%- if page and page.title -%}
          {{ page.title }} | {{ config.title | default(value='Goyo') }}
        {%- elif section and section.title -%}
          {{ section.title }} | {{ config.title | default(value='Goyo') }}
        {%- elif config.title -%}
          {{ config.title }}
        {%- else -%}
          Goyo
        {%- endif -%}
      " />
      <meta property="og:description" content="
        {%- if page and page.description -%}
          {{ page.description }}
        {%- elif section and section.description -%}
          {{ section.description }}
        {%- elif config.description -%}
          {{ config.description }}
        {%- endif -%}
      " />
      <meta property="og:url" content="{{ current_url | safe }}" />
      <meta property="og:type" content="website" />
      {% if page.extra.thumbnail %}
      <meta property="og:image" content="{{ get_url(path=page.extra.thumbnail) | safe }}" />
      {% elif config.extra.default_thumbnail %}
      <meta property="og:image" content="{{ get_url(path=config.extra.default_thumbnail) | safe }}" />
      {% endif %}

      <meta name="twitter:card" content="summary_large_image" />
      <meta name="twitter:title" content="{% if page %}{{ page.title }}{% else %}{{ config.title }}{% endif %}" />
      <meta name="twitter:description" content="
        {%- if page and page.description -%}
          {{ page.description }}
        {%- elif section and section.description -%}
          {{ section.description }}
        {%- elif config.description -%}
          {{ config.description }}
        {%- endif -%}
      " />
      {# Twitter configuration with backward compatibility #}
      {# Priority: twitter.* (new) > twitter_* (legacy) #}
      {% if config.extra.twitter is defined %}
          {% set twitter_site = config.extra.twitter.site | default(value=config.extra.twitter_site | default(value="")) %}
          {% set twitter_creator = config.extra.twitter.creator | default(value=config.extra.twitter_creator | default(value="")) %}
      {% else %}
          {% set twitter_site = config.extra.twitter_site | default(value="") %}
          {% set twitter_creator = config.extra.twitter_creator | default(value="") %}
      {% endif %}
      {% if twitter_site != "" %}
      <meta name="twitter:site" content="{{ twitter_site }}" />
      {% endif %}
      {% if twitter_creator != "" %}
      <meta name="twitter:creator" content="{{ twitter_creator }}" />
      {% endif %}
      {% if page.extra.thumbnail %}
      <meta name="twitter:image" content="{{ get_url(path=page.extra.thumbnail) | safe }}" />
      {% elif config.extra.default_thumbnail %}
      <meta name="twitter:image" content="{{ get_url(path=config.extra.default_thumbnail) | safe }}" />
      {% endif %}

      <!-- Structured Data (Schema.org JSON-LD) -->
      <script type="application/ld+json">
      {
        "@context": "https://schema.org",
        "@type": "WebSite",
        "name": "{{ config.title | default(value='Dhanur') }}",
        "url": "{{ config.base_url | safe }}",
        "description": "{{ config.description | default(value='') }}",
        {% if config.extra.logo and config.extra.logo.image_path %}
        "publisher": {
          "@type": "Organization",
          "name": "{{ config.title | default(value='Dhanur') }}",
          "logo": {
            "@type": "ImageObject",
            "url": "{{ get_url(path=config.extra.logo.image_path) | safe }}"
          }
        },
        {% endif %}
        "author": {
          "@type": "Person",
          "name": "{{ config.author | default(value='') }}"
        }
      }
      </script>

      <!-- Browser address bar color -->
      <meta name="theme-color" content="{{ self::get_theme_color(config=config) | trim }}">

      <!-- RSS Feed -->
      {% if config.generate_feeds %}
      <link rel="alternate" type="application/rss+xml" title="{{ config.title | default(value='RSS Feed') }}" href="{{ get_url(path='rss.xml', trailing_slash=false) | safe }}" />
      {% endif %}

      <!-- Favicon -->
      {# Favicon configuration #}
      {# Default path is /icons/ for all favicon files #}
      {# Users can override individual paths in [extra.favicon] section #}
      {% if config.extra.favicon is defined %}
          {% set favicon_base = config.extra.favicon.base_path | default(value="/icons/") %}
          {% set favicon_96x96 = config.extra.favicon.favicon_96x96 | default(value=favicon_base ~ "favicon-96x96.png") %}
          {% set favicon_svg = config.extra.favicon.favicon_svg | default(value=favicon_base ~ "favicon.svg") %}
          {% set favicon_ico = config.extra.favicon.favicon_ico | default(value=favicon_base ~ "favicon.ico") %}
          {% set apple_touch_icon = config.extra.favicon.apple_touch_icon | default(value=favicon_base ~ "apple-touch-icon.png") %}
          {% set site_webmanifest = config.extra.favicon.site_webmanifest | default(value=favicon_base ~ "site.webmanifest") %}
      {% else %}
          {% set favicon_base = "/icons/" %}
          {% set favicon_96x96 = favicon_base ~ "favicon-96x96.png" %}
          {% set favicon_svg = favicon_base ~ "favicon.svg" %}
          {% set favicon_ico = favicon_base ~ "favicon.ico" %}
          {% set apple_touch_icon = favicon_base ~ "apple-touch-icon.png" %}
          {% set site_webmanifest = favicon_base ~ "site.webmanifest" %}
      {% endif %}
      <link rel="icon" type="image/png" href="{{ favicon_96x96 | safe }}" sizes="96x96" />
      <link rel="icon" type="image/svg+xml" href="{{ favicon_svg | safe }}" />
      <link rel="shortcut icon" href="{{ favicon_ico | safe }}" />
      <link rel="apple-touch-icon" sizes="180x180" href="{{ apple_touch_icon | safe }}" />
      <link rel="manifest" href="{{ site_webmanifest | safe }}" />

      <!-- CSS -->
    <!-- Preload critical stylesheets for faster rendering -->
    <link rel="preload" href="{{ get_url(path="css/main.css") | safe }}" as="style">
    <link rel="stylesheet" href="{{ get_url(path="css/main.css") | safe }}">
    <!-- Load Font Awesome asynchronously without preload to reduce critical chain -->
    <link rel="stylesheet" href="{{ get_url(path="css/font-awesome.min.css") | safe }}" media="print" onload="this.media='all'">
    <noscript><link rel="stylesheet" href="{{ get_url(path="css/font-awesome.min.css") | safe }}"></noscript>
        <!-- Override Font Awesome font-display to swap to reduce FOIT/CLS -->
        <style>
            /* Inline override to avoid an extra render-blocking request */
            @font-face {
                font-family: "Font Awesome 6 Brands";
                font-style: normal;
                font-weight: 400;
                font-display: swap;
                src: url({{ get_url(path="webfonts/fa-brands-400.woff2") | safe }}) format("woff2"),
                         url({{ get_url(path="webfonts/fa-brands-400.ttf") | safe }}) format("truetype");
            }
            @font-face {
                font-family: "Font Awesome 6 Free";
                font-style: normal;
                font-weight: 400;
                font-display: swap;
                src: url({{ get_url(path="webfonts/fa-regular-400.woff2") | safe }}) format("woff2"),
                         url({{ get_url(path="webfonts/fa-regular-400.ttf") | safe }}) format("truetype");
            }
            @font-face {
                font-family: "Font Awesome 6 Free";
                font-style: normal;
                font-weight: 900;
                font-display: swap;
                src: url({{ get_url(path="webfonts/fa-solid-900.woff2") | safe }}) format("woff2"),
                         url({{ get_url(path="webfonts/fa-solid-900.ttf") | safe }}) format("truetype");
            }
        </style>

        <!-- Preload critical fonts with font-display: swap to prevent FOIT -->
        <link rel="preload" href="{{ get_url(path="fonts/Pretendard-Regular.woff") | safe }}" as="font" type="font/woff" crossorigin>
        <style>
            @font-face {
                font-family: 'Pretendard';
                src: url('{{ get_url(path="fonts/Pretendard-Regular.woff") | safe }}') format('woff');
                font-display: swap;
            }
        </style>

    <!-- Critical: Fix drawer state on back navigation (must NOT be deferred) -->
    <script>
        (function() {
            window.addEventListener('pageshow', function(e) {
                if (e.persisted) {
                    var d = document.getElementById('my-drawer-2');
                    if (d) d.checked = false;
                }
            });
        })();
    </script>

    <!-- Defer non-critical scripts -->
    <script defer src="{{ get_url(path="js/responsive-helpers.js") | safe }}"></script>
    <script defer src="{{ get_url(path="js/copy_code.js") | safe }}"></script>
    <script defer src="{{ get_url(path="js/copy_heading_link.js") | safe }}"></script>
    <script defer src="{{ get_url(path="js/clipboard.js") | safe }}"></script>
    <script defer src="{{ get_url(path="js/shortcut-hints.js") | safe }}"></script>
    <script defer src="{{ get_url(path="js/scroll-to-top.js") | safe }}"></script>
    <script defer src="{{ get_url(path="js/lazy-modules.js") | safe }}"
            data-katex-css="{{ get_url(path="css/katex.min.css") | safe }}"
            data-katex-js="{{ get_url(path="js/katex.min.js") | safe }}"
            data-mermaid-js="{{ get_url(path="js/mermaid.min.js") | safe }}"></script>
    <script defer src="{{ get_url(path="js/page-init.js") | safe }}"
            data-default-colorset="{{ config.extra.default_colorset | default(value="dark") }}"
            data-dark-brightness="{{ config.extra.dark_brightness | default(value="normal") }}"
            data-light-brightness="{{ config.extra.light_brightness | default(value="normal") }}"></script>
    <script defer src="{{ get_url(path="js/sw-register.js") | safe }}"
            data-sw-path="{{ get_url(path="sw.js") | safe }}"></script>
{% endmacro head %}
